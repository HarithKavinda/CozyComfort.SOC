@using System.Text.Json
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Distributor Dashboard";
    var mfgStock = ViewBag.ManufacturerStock as List<JsonElement> ?? new List<JsonElement>();
    var myStock = ViewBag.MyStock as List<JsonElement> ?? new List<JsonElement>();
    var notifications = ViewBag.Notifications as List<JsonElement> ?? new List<JsonElement>();
    var orders = ViewBag.Orders as List<JsonElement> ?? new List<JsonElement>();
    var sellers = ViewBag.Sellers as List<JsonElement> ?? new List<JsonElement>();
}

@if (TempData["Success"] != null) { <div class="alert alert-success"><i class="fas fa-check-circle"></i> @TempData["Success"]</div> }
@if (TempData["Error"] != null) { <div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> @TempData["Error"]</div> }
<div class="dashboard-header">
    <h1><i class="fas fa-truck"></i> Distributor Dashboard</h1>
    <p>View manufacturer stock, place orders, manage seller orders</p>
</div>

<div class="grid-2">
    <div class="card">
        <h3 style="margin-bottom: 1rem;">Manufacturer Stock (View Only)</h3>
        <table>
            <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Order</th></tr></thead>
            <tbody>
                @if (!mfgStock.Any()) { <tr><td colspan="4" style="color:var(--text-muted); text-align:center; padding:2rem;">No manufacturer stock available.</td></tr> }
                @foreach (var item in mfgStock)
                {
                    var name = item.TryGetProperty("productName", out var p) ? p.GetString() : item.GetProperty("ProductName").GetString();
                    var qty = item.TryGetProperty("quantity", out var q) ? q.GetInt32() : item.GetProperty("Quantity").GetInt32();
                    var pr = item.TryGetProperty("price", out var pr2) ? pr2.GetDecimal() : item.GetProperty("Price").GetDecimal();
                    <tr>
                        <td>@name</td>
                        <td>@qty</td>
                        <td>$@pr.ToString("N2")</td>
                        <td>
                            @if (qty > 0)
                            {
                                <form asp-controller="OrderActions" asp-action="PlaceOrderToManufacturer" method="post" style="display:inline;">
                                    <input type="hidden" name="productName" value="@name" />
                                    <input type="hidden" name="unitPrice" value="@pr" />
                                    <input type="number" name="quantity" min="1" max="@qty" value="1" style="width:60px; display:inline;" />
                                    <button type="submit" class="btn btn-sm"><i class="fas fa-shopping-cart"></i> Order</button>
                                </form>
                            }
                            else { <span style="color:var(--text-muted);">Out of stock</span> }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="card">
        <h3 style="margin-bottom: 1rem;">My Stock</h3>
        <table>
            <thead><tr><th>Product</th><th>Qty</th><th>Price</th></tr></thead>
            <tbody>
                @if (!myStock.Any()) { <tr><td colspan="3" style="color:var(--text-muted); text-align:center; padding:2rem;">Your stock is empty. Place an order from the manufacturer.</td></tr> }
                @foreach (var item in myStock)
                {
                    var name = item.TryGetProperty("productName", out var p) ? p.GetString() : item.GetProperty("ProductName").GetString();
                    var qty = item.TryGetProperty("quantity", out var q) ? q.GetInt32() : item.GetProperty("Quantity").GetInt32();
                    var pr = item.TryGetProperty("price", out var pr2) ? pr2.GetDecimal() : item.GetProperty("Price").GetDecimal();
                    <tr><td>@name</td><td>@qty</td><td>$@pr.ToString("N2")</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
    <h3 style="margin-bottom:1rem;"><i class="fas fa-envelope"></i> Send Message to Seller</h3>
    @if (sellers.Any())
    {
        <form asp-controller="Message" asp-action="Send" method="post" style="display:grid; grid-template-columns:1fr 2fr auto; gap:1rem; align-items:end; margin-bottom:1.5rem;">
            <div>
                <label>To Seller</label>
                <select name="toUserId" required>
                    <option value="">-- Select --</option>
                    @foreach (var s in sellers)
                    {
                        var sid = s.TryGetProperty("userId", out var su) ? su.GetInt32() : s.GetProperty("UserId").GetInt32();
                        var email = s.TryGetProperty("email", out var se) ? se.GetString() : s.GetProperty("Email").GetString();
                        <option value="@sid">@email</option>
                    }
                </select>
            </div>
            <div>
                <label>Message</label>
                <input type="text" name="content" placeholder="Your order has been shipped..." required />
            </div>
            <button type="submit" class="btn btn-sm"><i class="fas fa-paper-plane"></i> Send</button>
        </form>
    }
    <h3>Orders from Sellers &amp; Notifications</h3>
    <div class="tab-container">
        <button class="tab active" onclick="showTab('sellerOrders', this)"><i class="fas fa-shopping-cart"></i> Seller Orders</button>
        <button class="tab" onclick="showTab('notif', this)"><i class="fas fa-bell"></i> Notifications (@notifications.Count)</button>
        <button class="tab" onclick="showTab('messages', this)"><i class="fas fa-inbox"></i> Messages</button>
    </div>
    <div id="sellerOrders" class="tab-content">
        <table>
            <thead><tr><th>Product</th><th>Qty</th><th>Status</th><th>Action</th></tr></thead>
            <tbody>
                @if (!orders.Any()) { <tr><td colspan="4" style="color:var(--text-muted); text-align:center; padding:2rem;">No seller orders yet.</td></tr> }
                @foreach (var o in orders)
                {
                    var oid = o.TryGetProperty("id", out var oi) ? oi.GetInt32() : o.GetProperty("Id").GetInt32();
                    var pn = o.TryGetProperty("productName", out var op) ? op.GetString() : o.GetProperty("ProductName").GetString();
                    var q = o.TryGetProperty("quantity", out var oq) ? oq.GetInt32() : o.GetProperty("Quantity").GetInt32();
                    var st = o.TryGetProperty("status", out var os) ? os.GetString() : o.GetProperty("Status").GetString();
                    <tr>
                        <td>@pn</td>
                        <td>@q</td>
                        <td>@st</td>
                        <td>
                            @if (st == "Pending")
                            {
                                <form asp-controller="OrderActions" asp-action="MarkShipped" method="post" style="display:inline;">
                                    <input type="hidden" name="id" value="@oid" />
                                    <button type="submit" class="btn btn-sm">Mark Shipped</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div id="notif" class="tab-content" style="display:none;">
        @if (!notifications.Any()) { <p style="color:var(--text-muted); text-align:center; padding:2rem;">No notifications.</p> }
        @foreach (var n in notifications)
        {
            var title = n.TryGetProperty("title", out var t) ? t.GetString() : n.GetProperty("Title").GetString();
            var msg = n.TryGetProperty("message", out var m) ? m.GetString() : n.GetProperty("Message").GetString();
            <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <strong>@title</strong><br /><span style="color: var(--text-muted);">@msg</span>
            </div>
        }
    </div>
    <div id="messages" class="tab-content" style="display:none;">
        @{ var messages = ViewBag.Messages as List<JsonElement> ?? new List<JsonElement>(); }
        @if (!messages.Any()) { <p style="color:var(--text-muted); text-align:center; padding:2rem;">No messages.</p> }
        @foreach (var msg in messages)
        {
            var content = msg.TryGetProperty("content", out var mc) ? mc.GetString() : msg.GetProperty("Content").GetString();
            var fromId = msg.TryGetProperty("fromUserId", out var mf) ? mf.GetInt32() : msg.GetProperty("FromUserId").GetInt32();
            <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <strong>From User #@fromId</strong><br /><span style="color: var(--text-muted);">@content</span>
            </div>
        }
    </div>
</div>

<script>
    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        var el = document.getElementById(id); if (el) el.style.display = 'block';
        if (btn) btn.classList.add('active');
    }
</script>
